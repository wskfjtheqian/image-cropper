(function(i,g){typeof exports=="object"&&typeof module<"u"?module.exports=g():typeof define=="function"&&define.amd?define(g):(i=typeof globalThis<"u"?globalThis:i||self,i.ImageCropperLib=g())})(this,(function(){"use strict";class i{constructor(t,e){this.x=t,this.y=e}}class g{constructor(t,e,s){this.x=t,this.y=e,this.z=s}}class a{constructor(t,e,s,o){this.left=t,this.top=e,this.right=s,this.bottom=o}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get center(){return new i((this.right-this.left)/2,(this.bottom-this.top)/2)}clone(){return new a(this.left,this.top,this.right,this.bottom)}}class l{constructor(t,e,s){this.layoutList=[],this.rect=new a(0,0,0,0),this.parent=null,this.config={backgroundBoxSize:10,backgroundBoxColor0:"#fff",backgroundBoxColor1:"#ddd"},this.parent=t,this.cursor=e,Object.assign(this.config,s)}setRect(t){this.rect=t}getRect(){return this.rect}getRoot(){let t=this.parent;for(;t?.parent;)t=t.parent;return t}checkPointInRect(t){return t.x>=this.rect.left&&t.x<=this.rect.right&&t.y>=this.rect.top&&t.y<=this.rect.bottom}start(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].start(t))return!0;return!1}move(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].move(t))return!0;return!1}end(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].end(t))return!0;return!1}wheel(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].wheel(t))return!0;return!1}over(){this.getRoot()?.setCursor(this.cursor)}out(){}checkOverOut(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].checkOverOut(t))return!0;return this.checkPointInRect(t)?(this.getRoot()?.setOverLayout(this,t),!0):!1}draw(t){for(const e of this.layoutList)e.draw(t)}}class R extends l{constructor(t,e){super(t,"crosshair",e),this.mousePoint=new i(0,0),this.selectRect=new a(0,0,0,0),this.onStartSelect=null,this.onMoveSelect=null,this.onEndSelect=null}setOnStartSelect(t){this.onStartSelect=t}setOnMoveSelect(t){this.onMoveSelect=t}setOnEndSelect(t){this.onEndSelect=t}start(t){return this.mousePoint=t,this.selectRect=new a(t.x,t.y,t.x,t.y),this.onStartSelect?.call(this,this.selectRect),!0}move(t){return this.selectRect.right+=t.x-this.mousePoint.x,this.selectRect.bottom+=t.y-this.mousePoint.y,this.mousePoint=t,this.onMoveSelect?.call(this,this.selectRect),!0}end(){return this.onEndSelect?.call(this,this.selectRect),!0}draw(t){const{left:e,top:s,right:o,bottom:h}=this.rect,n=o-e,r=h-s;for(let d=0;d<r;d+=this.config.backgroundBoxSize){let f=Math.floor(d/this.config.backgroundBoxSize)%2?this.config.backgroundBoxColor0:this.config.backgroundBoxColor1;for(let m=0;m<n;m+=this.config.backgroundBoxSize)t.fillStyle=f=f===this.config.backgroundBoxColor1?this.config.backgroundBoxColor0:this.config.backgroundBoxColor1,t.fillRect(m,d,this.config.backgroundBoxSize,this.config.backgroundBoxSize)}}}class y extends l{constructor(t,e="auto"){super(t,e),this.scale=1,this.angle=0,this.clipRect=new a(0,0,0,0),this.offset=new i(0,0)}setRect(t){super.setRect(t),this.clipRect=new a(t.left,t.top,t.right,t.bottom)}setClipRect(t){console.log(t);const e=new i(this.clipRect.left+this.clipRect.width/2-(t.left+t.width/2),this.clipRect.top+this.clipRect.height/2-(t.top+t.height/2));console.log(e),this.moveImage(e),this.clipRect=t}setImage(t){this.image=t;const e=this.rect.width/t.width,s=this.rect.height/t.height;this.scale=Math.min(e,s)}setRotate(t){this.angle-=t}start(){return!1}move(){return!1}end(){return!1}wheel(t){return t.y<0?this.scale*=1+.1:this.scale*=1-.1,this.scale=Math.max(.1,Math.min(5,this.scale)),!0}moveImage(t){const e=Math.cos(-this.angle*Math.PI/180),s=Math.sin(-this.angle*Math.PI/180),o=t.x*e-t.y*s,h=t.x*s+t.y*e;this.offset.x+=o/this.scale,this.offset.y+=h/this.scale}draw(t){if(!this.image)return;const e=new i(this.clipRect.left+this.clipRect.width/2,this.clipRect.top+this.clipRect.height/2);t.save(),t.translate(e.x,e.y),t.scale(this.scale,this.scale),t.rotate(this.angle*Math.PI/180),t.translate(this.offset.x,this.offset.y),t.drawImage(this.image,-this.image.width/2,-this.image.height/2),t.restore()}getClipCanvas(){const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("no canvas context");return t.width=this.clipRect.width,t.height=this.clipRect.height,e.save(),e.translate(this.clipRect.width/2,this.clipRect.height/2),e.scale(this.scale,this.scale),e.rotate(this.angle*Math.PI/180),e.translate(this.offset.x,this.offset.y),e.drawImage(this.image,-this.image.width/2,-this.image.height/2,this.image.width,this.image.height),e.restore(),t}toBlob(t,e){return this.image?new Promise((s,o)=>{try{this.getClipCanvas().toBlob(h=>{s(h)},t??"image/png",e)}catch(h){o(h)}}):Promise.reject(new Error("image not loaded"))}toDataUrl(t,e){return this.image?new Promise((s,o)=>{try{s(this.getClipCanvas().toDataURL(t??"image/png",e))}catch(h){o(h)}}):Promise.reject(new Error("image not loaded"))}}class w extends l{constructor(t,e="move"){super(t,e),this.maskLineColor="#000",this.maskLineWidth=2,this.topLeft=new c(this,"nwse-resize"),this.topCenter=new c(this,"ns-resize"),this.topRight=new c(this,"nesw-resize"),this.centerLeft=new c(this,"ew-resize "),this.centerRight=new c(this,"ew-resize "),this.bottomLeft=new c(this,"nesw-resize"),this.bottomCenter=new c(this,"ns-resize"),this.bottomRight=new c(this,"nwse-resize"),this.layoutList=[],this.pointRadius=6,this.isChecked=!1,this.mousePoint=new i(0,0),this.onMoveLayout=null,this.onEndSelect=null,this.topLeft.setOnMoveLayout(this.onMoveTopLeft.bind(this)),this.topCenter.setOnMoveLayout(this.onMoveTopCenter.bind(this)),this.topRight.setOnMoveLayout(this.onMoveTopRight.bind(this)),this.centerLeft.setOnMoveLayout(this.onMoveCenterLeft.bind(this)),this.centerRight.setOnMoveLayout(this.onMoveCenterRight.bind(this)),this.bottomLeft.setOnMoveLayout(this.onMoveBottomLeft.bind(this)),this.bottomCenter.setOnMoveLayout(this.onMoveBottomCenter.bind(this)),this.bottomRight.setOnMoveLayout(this.onMoveBottomRight.bind(this)),this.topLeft.setOnEndLayout(this.onEndLayout.bind(this)),this.topCenter.setOnEndLayout(this.onEndLayout.bind(this)),this.topRight.setOnEndLayout(this.onEndLayout.bind(this)),this.centerLeft.setOnEndLayout(this.onEndLayout.bind(this)),this.centerRight.setOnEndLayout(this.onEndLayout.bind(this)),this.bottomLeft.setOnEndLayout(this.onEndLayout.bind(this)),this.bottomCenter.setOnEndLayout(this.onEndLayout.bind(this)),this.bottomRight.setOnEndLayout(this.onEndLayout.bind(this)),this.layoutList=[this.topLeft,this.topCenter,this.topRight,this.centerLeft,this.centerRight,this.bottomLeft,this.bottomCenter,this.bottomRight]}onEndLayout(){this.onEndSelect?.call(this,this.rect)}setOnMoveLayout(t){this.onMoveLayout=t}setOnEndSelect(t){this.onEndSelect=t}onMoveTopLeft(t){this.rect.left=this.rect.left+t.x,this.rect.top=this.rect.top+t.y,this.setRect(this.rect)}onMoveTopCenter(t){this.rect.top=this.rect.top+t.y,this.setRect(this.rect)}onMoveTopRight(t){this.rect.right=this.rect.right+t.x,this.rect.top=this.rect.top+t.y,this.setRect(this.rect)}onMoveCenterLeft(t){this.rect.left=this.rect.left+t.x,this.setRect(this.rect)}onMoveCenterRight(t){this.rect.right=this.rect.right+t.x,this.setRect(this.rect)}onMoveBottomLeft(t){this.rect.left=this.rect.left+t.x,this.rect.bottom=this.rect.bottom+t.y,this.setRect(this.rect)}onMoveBottomCenter(t){this.rect.bottom=this.rect.bottom+t.y,this.setRect(this.rect)}onMoveBottomRight(t){this.rect.right=this.rect.right+t.x,this.rect.bottom=this.rect.bottom+t.y,this.setRect(this.rect)}start(t){return super.start(t)?!0:this.checkPointInRect(t)?(this.isChecked=!0,this.mousePoint=t,!0):!1}move(t){return this.isChecked&&(this.onMoveLayout?.call(this,new i(t.x-this.mousePoint.x,t.y-this.mousePoint.y)),this.mousePoint=t),super.move(t)}end(t){return this.isChecked&&(this.onMoveLayout?.call(this,new i(t.x-this.mousePoint.x,t.y-this.mousePoint.y)),this.mousePoint=t,this.isChecked=!1),super.end(t)}setRect(t){super.setRect(t);const{left:e,top:s,right:o,bottom:h}=t,n=o-e,r=h-s;this.topLeft.setRect(new a(e-this.pointRadius,s-this.pointRadius,e+this.pointRadius*2,s+this.pointRadius*2)),this.topCenter.setRect(new a(e+n/2-this.pointRadius,s-this.pointRadius,e+n/2+this.pointRadius*2,s+this.pointRadius*2)),this.topRight.setRect(new a(o-this.pointRadius,s-this.pointRadius,o+this.pointRadius*2,s+this.pointRadius*2)),this.centerLeft.setRect(new a(e-this.pointRadius,s+r/2-this.pointRadius,e+this.pointRadius*2,s+r/2+this.pointRadius*2)),this.centerRight.setRect(new a(o-this.pointRadius,s+r/2-this.pointRadius,o+this.pointRadius*2,s+r/2+this.pointRadius*2)),this.bottomLeft.setRect(new a(e-this.pointRadius,h-this.pointRadius,e+this.pointRadius*2,h+this.pointRadius*2)),this.bottomCenter.setRect(new a(e+n/2-this.pointRadius,h-this.pointRadius,e+n/2+this.pointRadius*2,h+this.pointRadius*2)),this.bottomRight.setRect(new a(o-this.pointRadius,h-this.pointRadius,o+this.pointRadius*2,h+this.pointRadius*2))}drawMask(t){t.rect(this.rect.left,this.rect.top,this.rect.width,this.rect.height)}drawLine(t,e,s){t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(s.x,s.y),t.closePath(),t.strokeStyle="rgba(255,255,255,0.31)",t.setLineDash([4,5]),t.lineWidth=1,t.stroke()}draw(t){const{left:e,top:s,right:o,bottom:h}=this.rect;let n=o-e,r=h-s;t.save(),t.beginPath(),t.rect(e,s,n,r),t.closePath(),t.strokeStyle=this.maskLineColor,t.lineWidth=this.maskLineWidth,t.stroke(),t.restore(),n=n/4,r=r/4,t.save(),this.drawLine(t,new i(e,s+r),new i(o,s+r)),this.drawLine(t,new i(e,s+r*2),new i(o,s+r*2)),this.drawLine(t,new i(e,s+r*3),new i(o,s+r*3)),this.drawLine(t,new i(e+n,s),new i(e+n,h)),this.drawLine(t,new i(e+n*2,s),new i(e+n*2,h)),this.drawLine(t,new i(e+n*3,s),new i(e+n*3,h)),t.restore(),super.draw(t)}}class c extends l{constructor(){super(...arguments),this.maskLineColor="#000",this.isChecked=!1,this.mousePoint=new i(0,0),this.onMoveLayout=null,this.onEndLayout=null}setOnMoveLayout(t){this.onMoveLayout=t}setOnEndLayout(t){this.onEndLayout=t}start(t){return this.checkPointInRect(t)?(this.isChecked=!0,this.mousePoint=t,!0):!1}move(t){return this.isChecked&&(this.onMoveLayout?.call(this,new i(t.x-this.mousePoint.x,t.y-this.mousePoint.y)),this.mousePoint=t),!1}end(t){return this.isChecked&&(this.onEndLayout?.call(this,new i(t.x-this.mousePoint.x,t.y-this.mousePoint.y)),this.mousePoint=t,this.isChecked=!1),!1}draw(t){const{left:e,top:s,right:o,bottom:h}=this.rect;t.beginPath(),t.rect(e,s,o-e,h-s),t.closePath(),t.fillStyle=this.maskLineColor,t.fill()}}class p extends l{constructor(t,e="pointer"){super(t,e),this.maskColor="#88888888",this.isSelect=!0,this.handle=new w(this),this.isChecked=!1,this.mousePoint=new i(0,0),this.onRotateLayout=null,this.layoutList.push(this.handle)}setOnRotateLayout(t){this.onRotateLayout=t}setOnEndSelect(t){this.handle.setOnEndSelect(t)}start(t){return this.isSelect?!1:(super.start(t)||this.checkPointInRect(t)&&(this.isChecked=!0,this.mousePoint=t),!0)}move(t){if(this.isSelect)return!1;if(this.isChecked){const e=this.getRect(),s=new i(e.left+e.width/2,e.top+e.height/2),o=t.x-s.x,h=t.y-s.y,n=this.mousePoint.x-s.x,r=this.mousePoint.y-s.y,d=(Math.atan2(r,n)-Math.atan2(h,o))*(180/Math.PI);return this.onRotateLayout?.call(this,d),this.mousePoint=t,!0}return super.move(t),!0}end(t){return this.isSelect?!1:(this.isChecked=!1,super.end(t),!0)}setHandleRect(t){this.handle.setRect(t)}endSelect(t){this.handle.setRect(t),this.isSelect=!1}setOnMoveLayout(t){this.handle.setOnMoveLayout(t)}draw(t){const{left:e,top:s,right:o,bottom:h}=this.rect,n=o-e,r=h-s;t.fillStyle=this.maskColor,t.beginPath(),t.rect(e,s,n,r),this.handle.drawMask(t),t.closePath(),t.fill("evenodd"),super.draw(t)}}class L extends l{constructor(t,e){super(null,"auto",e),this.background=new R(this),this.overLayout=null,this.layoutList=[],this.canvas=t,this.canvas2D=t.getContext("2d"),this.setRect(new a(0,0,this.canvas.width,this.canvas.height)),this.initBackground(),t.addEventListener("mousedown",this.onMouseDown.bind(this)),t.addEventListener("mousemove",this.onMouseMove.bind(this)),t.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("wheel",this.onMouseWheel.bind(this)),t.addEventListener("touchstart",this.onTouchStart.bind(this)),t.addEventListener("touchmove",this.onTouchMove.bind(this)),t.addEventListener("touchend",this.onTouchEnd.bind(this)),this.draw(this.canvas2D)}setCursor(t){this.canvas.style.cursor=t}start(t){return super.start(t),this.draw(this.canvas2D),!0}move(t){return this.checkOverOut(t),super.move(t),this.draw(this.canvas2D),!0}end(t){return super.end(t),this.draw(this.canvas2D),!0}onTouchStart(t){t.preventDefault(),t.touches.length!==0&&this.start(new i(t.touches[0].clientX,t.touches[0].clientY))}onTouchMove(t){t.preventDefault(),t.touches.length!==0&&this.move(new i(t.touches[0].clientX,t.touches[0].clientY))}onTouchEnd(t){t.preventDefault(),this.end(new i(t.changedTouches[0].clientX,t.changedTouches[0].clientY))}onMouseDown(t){t.preventDefault(),this.start(new i(t.offsetX,t.offsetY))}onMouseMove(t){t.preventDefault(),this.move(new i(t.offsetX,t.offsetY))}onMouseUp(t){t.preventDefault(),this.end(new i(t.offsetX,t.offsetY))}onMouseOver(t){t.preventDefault(),this.over()}onMouseWheel(t){t.preventDefault(),this.wheel(new g(t.deltaX,t.deltaY,t.deltaZ)),this.draw(this.canvas2D)}setImage(t){this.image=new y(this),this.image.setRect(this.rect.clone()),this.image.setImage(t),this.layoutList.push(this.image),this.draw(this.canvas2D)}setOverLayout(t){this.overLayout!=t&&(this.overLayout?.out(),this.overLayout=t,this.overLayout.over())}toDataUrl(t,e){return this.image?this.mask?this.image.toDataUrl(t,e):Promise.reject("No mask"):Promise.reject("No image")}toBlob(t,e){return this.image?this.mask?this.image.toBlob(t,e):Promise.reject("No mask"):Promise.reject("No image")}initBackground(){this.background.setRect(this.rect),this.layoutList.push(this.background),this.background.setOnStartSelect(t=>{this.mask||(this.mask=new p(this),this.mask.setOnMoveLayout(e=>{this.image?.moveImage(e)}),this.mask.setOnRotateLayout(e=>{this.image?.setRotate(e)}),this.mask.setOnEndSelect(e=>{this.image?.setClipRect(e.clone())}),this.mask.setRect(this.rect),this.mask.setHandleRect(t.clone()),this.layoutList.push(this.mask))}),this.background.setOnMoveSelect(t=>{this.mask?.setHandleRect(t.clone())}),this.background.setOnEndSelect(t=>{this.mask?.endSelect(t.clone()),this.image?.setClipRect(t.clone())})}}return L}));
