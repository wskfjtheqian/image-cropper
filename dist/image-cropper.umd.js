(function(v,l){typeof exports=="object"&&typeof module<"u"?module.exports=l():typeof define=="function"&&define.amd?define(l):(v=typeof globalThis<"u"?globalThis:v||self,v.ImageCropperLib=l())})(this,(function(){"use strict";class l{constructor(t,e,i,s){this.angle=0,this.width=t,this.height=e,this.path=s,this.viewBox=i}clone(t){const e=new l(this.width,this.height,this.viewBox,this.path);return e.setAngle(t??this.angle),e}setAngle(t){this.angle=t}setViewBox(t,e,i,s){this.viewBox=[t,e,i,s]}draw(t,e,i,s="#000",o,c=1){if(!this.path||this.path.length===0)return;t.save(),t.lineJoin="round",t.lineCap="round";let r=0,h=0,g=this.width,u=this.height;this.viewBox&&([r,h,g,u]=this.viewBox);const p=e/g,m=i/u,y=Math.min(p,m);t.translate(e/2,i/2),t.rotate(this.angle*Math.PI/180),t.scale(y,y),t.translate(-g/2-r+.5/y,-u/2-h+.5/y);const S=new Path2D;for(const T of this.path)S.addPath(new Path2D(T));t.strokeStyle=s,t.lineWidth=Math.max(1,c/y),t.stroke(S),o&&(t.fillStyle=o,t.fill(S)),t.restore()}}const M=new l(24,24,[0,0,24,24],["M13.6,12c0,0.9-0.7,1.6-1.6,1.6s-1.6-0.7-1.6-1.6s0.7-1.6,1.6-1.6S13.6,11.1,13.6,12z M21,10.4v3.3h-2.1c-0.6,2.6-2.7,4.7-5.3,5.3V21h-3.3v-2.1c-2.6-0.6-4.7-2.7-5.3-5.3H3v-3.3h2.1c0.6-2.6,2.7-4.7,5.3-5.3V3h3.3v2.1c2.6,0.6,4.7,2.7,5.3,5.3H21z M16.7,12c0-2.6-2.1-4.7-4.7-4.7S7.3,9.4,7.3,12s2.1,4.7,4.7,4.7S16.7,14.6,16.7,12z"]),b=new l(24,24,[0,0,24,24],["M0,4.96h24V11H0V4.96z"]),R=new l(24,24,[0,0,24,24],["M12.91,4.96 L0,4.96 L0,11 L12.91,11 L12.91,24 L18.95,24 L18.95,11 L18.95,4.96 Z"]),w=new l(24,24,[0,0,24,24],["M13.7,12L13.7,12l0-7.3H17L12,0.1L6.9,4.7h3.3v14.5H6.8l5.1,4.7l5.1-4.7h-3.3V12z"]),C=new l(24,24,[0,0,24,24],["M20.8,18.3L20.8,18.3l-0.3,0c0,0,0,0,0,0c0-8.2-6.6-14.8-14.8-14.8c0,0-0.1,0-0.1,0V0.2L0.1,5.7l5.5,5.5V7.6c0,0,0.1,0,0.1,0c5.9,0,10.7,4.8,10.7,10.7c0,0,0,0,0,0h-0.3l-0.1,0h-3.1l5.5,5.5l5.5-5.5H20.8z"]),k=new l(24,24,[0,0,24,24],["M19.3,17.1v-3.3h-5.5v5.5h3.3l-5.2,4.7l-5.1-4.7h3.3v-5.5H4.6v3.3L-0.1,12l4.7-5.2v3.4h5.5V4.7H6.8L12-0.1l5.1,4.7h-3.3v5.5h5.5V6.8L24,12L19.3,17.1z"]),P=new l(24,24,[0,0,24,24],["M24,13.9H13.9V24h-4V13.9H-0.1v-4H10v-10h4v10H24V13.9z"]),z=new l(24,24,[0,0,24,24],["M18.8,5.4c-0.4,0-0.7,0.1-1,0.4c-0.3,0.3-0.4,0.6-0.4,1v5.6c0,0.3-0.2,0.4-0.4,0.4c-0.1,0-0.2,0-0.3-0.1c-0.1-0.1-0.1-0.2-0.1-0.3V3.1c0-0.4-0.1-0.7-0.4-1c-0.3-0.3-0.6-0.4-1-0.4c-0.4,0-0.7,0.1-1,0.4c-0.3,0.3-0.4,0.6-0.4,1v8c0,0.1,0,0.2-0.1,0.3c-0.1,0.1-0.2,0.1-0.3,0.1s-0.2,0-0.3-0.1c-0.1-0.1-0.1-0.2-0.1-0.3V1.9c0-0.4-0.1-0.7-0.4-1c-0.3-0.3-0.6-0.4-1-0.4c-0.4,0-0.7,0.1-1,0.4c-0.3,0.3-0.4,0.6-0.4,1v9.3c0,0.3-0.2,0.4-0.4,0.4c-0.1,0-0.2,0-0.3-0.1c-0.1-0.1-0.1-0.2-0.1-0.3v-8c0-0.4-0.1-0.7-0.4-1s-0.6-0.4-1-0.4s-0.7,0.1-1,0.4c-0.3,0.3-0.4,0.6-0.4,1v9.7c0,0.4-0.1,0.7-0.2,0.9c-0.1,0.2-0.2,0.3-0.4,0.4c-0.2,0-0.4,0-0.5-0.1c-0.2-0.1-0.4-0.4-0.6-0.7l-2-3.4C2.7,9.5,2.4,9.3,2.1,9.2c-0.3-0.1-0.7,0-1,0.1c-0.3,0.2-0.5,0.5-0.6,0.9c-0.1,0.4-0.1,0.8,0.1,1.1s0.2,0.3,0.2,0.3l0.5,1.1L3.8,18c0.6,1.2,1.2,2.2,1.8,3c0.5,0.6,1,1.1,1.5,1.5c0.3,0.3,0.7,0.4,1,0.6c0.2,0.1,0.3,0.1,0.4,0.1h6.1c0.9,0,1.8-0.3,2.5-1c0.6-0.5,1.1-1.2,1.5-2.1c1-2.1,1.6-4.8,1.6-8.2V6.8c0-0.4-0.1-0.7-0.4-1C19.6,5.6,19.2,5.4,18.8,5.4L18.8,5.4z"]);class n{constructor(t,e){this.x=t,this.y=e}}class O{constructor(t,e,i){this.x=t,this.y=e,this.z=i}}class a{constructor(t,e,i,s){this.left=t,this.top=e,this.right=i,this.bottom=s}static fromSize(t,e,i,s){return new a(t,e,t+i,e+s)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}get center(){return new n((this.right-this.left)/2,(this.bottom-this.top)/2)}clone(){return new a(this.left,this.top,this.right,this.bottom)}}class L{constructor(t,e,i){this.layoutList=[],this.rect=new a(0,0,0,0),this.parent=null,this.config={backgroundBoxSize:10,backgroundBoxColor0:"#fff",backgroundBoxColor1:"#ddd",guidelineWidth:1,guidelineColor1:"#ffffff60",guidelineColor2:"#00000060",guidelineDsah:4,borderWidth:1.5,borderColor1:"#000000",borderColor2:"#ffffff",pointRadius:12,cursorStrokeLineWidth:2,cursorStrokeColor:"#ffffff",cursorColor:"#000000",cursorSize:18},this.parent=t,this.cursor=e,Object.assign(this.config,i)}setRect(t){this.rect=t}getRect(){return this.rect}getRoot(){let t=this.parent;for(;t?.parent;)t=t.parent;return t}checkPointInRect(t){return t.x>=this.rect.left&&t.x<=this.rect.right&&t.y>=this.rect.top&&t.y<=this.rect.bottom}start(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].start(t))return!0;return!1}move(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].move(t))return!0;return!1}end(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].end(t))return!0;return!1}wheel(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].wheel(t))return!0;return!1}over(){this.getRoot()?.setCursor(this.cursor)}out(){}checkOverOut(t){for(let e=this.layoutList.length-1;e>=0;e--)if(this.layoutList[e].checkOverOut(t))return!0;return this.checkPointInRect(t)?(this.getRoot()?.setOverLayout(this,t),!0):!1}draw(t){for(const e of this.layoutList)t.save(),e.draw(t),t.restore()}remove(){this.parent?.layoutList.splice(this.parent.layoutList.indexOf(this),1)}}class H extends L{constructor(t,e){super(t,P.clone(),e),this.mousePoint=new n(0,0),this.selectRect=new a(0,0,0,0),this.onStartSelect=null,this.onMoveSelect=null,this.onEndSelect=null}setOnStartSelect(t){this.onStartSelect=t}setOnMoveSelect(t){this.onMoveSelect=t}setOnEndSelect(t){this.onEndSelect=t}start(t){return this.mousePoint=t,this.selectRect=new a(t.x,t.y,t.x,t.y),this.onStartSelect?.call(this,this.selectRect),!0}move(t){const e=this.selectRect.clone();if(e.right+=t.x-this.mousePoint.x,e.bottom+=t.y-this.mousePoint.y,this.config?.outWidth&&this.config?.outHeight){const i=Math.min(e.width/this.config?.outWidth,e.height/this.config?.outHeight);e.right=e.left+this.config?.outWidth*i,e.bottom=e.top+this.config?.outHeight*i}return this.selectRect=e,this.mousePoint=t,this.onMoveSelect?.call(this,this.selectRect),!0}end(){return this.onEndSelect?.call(this,this.selectRect),!0}draw(t){const{left:e,top:i,right:s,bottom:o}=this.rect,c=s-e,r=o-i;for(let h=0;h<r;h+=this.config.backgroundBoxSize){let g=Math.floor(h/this.config.backgroundBoxSize)%2?this.config.backgroundBoxColor0:this.config.backgroundBoxColor1;for(let u=0;u<c;u+=this.config.backgroundBoxSize)t.fillStyle=g=g===this.config.backgroundBoxColor1?this.config.backgroundBoxColor0:this.config.backgroundBoxColor1,t.fillRect(u,h,this.config.backgroundBoxSize,this.config.backgroundBoxSize)}}}class E extends L{constructor(t,e){super(t,null,e),this.scale=1,this.angle=0,this.clipRect=new a(0,0,0,0),this.offset=new n(0,0)}initScale(t){this.image&&(this.scale=Math.max(t.width/this.image.width,t.height/this.image.height))}reset(){this.angle=0,this.offset=new n(0,0),this.config.defaultClipRect?this.scale=Math.max(this.clipRect.width/this.image.width,this.clipRect.height/this.image.height):(this.clipRect=new a(this.rect.left,this.rect.top,this.rect.right,this.rect.bottom),this.scale=Math.min(this.rect.width/this.image.width,this.rect.height/this.image.height))}setRect(t){super.setRect(t),this.clipRect=new a(t.left,t.top,t.right,t.bottom)}setClipRect(t){const e=new n(this.clipRect.left+this.clipRect.width/2-(t.left+t.width/2),this.clipRect.top+this.clipRect.height/2-(t.top+t.height/2));this.moveImage(e),this.clipRect=t}checkOverOut(t){return!1}setImage(t){this.image=t;const e=this.rect.width/t.width,i=this.rect.height/t.height;this.scale=Math.min(e,i)}setRotate(t){this.angle-=t}start(){return!1}move(){return!1}end(){return!1}wheel(t){return t.y<0?this.scale*=1+.1:this.scale*=1-.1,this.scale=Math.max(.1,Math.min(5,this.scale)),!0}moveImage(t){const e=Math.cos(-this.angle*Math.PI/180),i=Math.sin(-this.angle*Math.PI/180),s=t.x*e-t.y*i,o=t.x*i+t.y*e;this.offset.x+=s/this.scale,this.offset.y+=o/this.scale}draw(t){if(!this.image)return;const e=new n(this.clipRect.left+this.clipRect.width/2,this.clipRect.top+this.clipRect.height/2);t.translate(e.x,e.y),t.scale(this.scale,this.scale),t.rotate(this.angle*Math.PI/180),t.translate(this.offset.x,this.offset.y),t.drawImage(this.image,-this.image.width/2,-this.image.height/2)}getClipCanvas(){const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)throw new Error("no canvas context");let i=1;return this.config.outType==0&&(this.config?.outWidth&&this.config?.outHeight?i=Math.min(this.config?.outWidth/this.clipRect.width,this.config?.outHeight/this.clipRect.height):this.config?.outWidth?i=this.config?.outWidth/this.clipRect.width:this.config?.outHeight&&(i=this.config?.outHeight/this.clipRect.height)),t.width=this.clipRect.width*i,t.height=this.clipRect.height*i,e.translate(t.width/2,t.height/2),e.scale(this.scale*i,this.scale*i),e.rotate(this.angle*Math.PI/180),e.translate(this.offset.x,this.offset.y),e.drawImage(this.image,-this.image.width/2,-this.image.height/2,this.image.width,this.image.height),t}toBlob(t,e){return this.image?new Promise((i,s)=>{try{this.getClipCanvas().toBlob(o=>{i(o)},t??"image/png",e)}catch(o){s(o)}}):Promise.reject(new Error("image not loaded"))}toDataUrl(t,e){return this.image?new Promise((i,s)=>{try{i(this.getClipCanvas().toDataURL(t??"image/png",e))}catch(o){s(o)}}):Promise.reject(new Error("image not loaded"))}}class W extends L{constructor(t,e,i){super(t,e,i),this.layoutList=[],this.isChecked=!1,this.mousePoint=new n(0,0),this.onMoveLayout=null,this.onEndSelect=null,this.center=new B(this,M,0,z.clone(),i),this.topLeft=new d(this,R,-90,w.clone(-45),i),this.topCenter=new d(this,b,0,w.clone(),i),this.topRight=new d(this,R,0,w.clone(45),i),this.centerLeft=new d(this,b,-90,w.clone(90),i),this.centerRight=new d(this,b,90,w.clone(90),i),this.bottomLeft=new d(this,R,180,w.clone(45),i),this.bottomCenter=new d(this,b,180,w.clone(),i),this.bottomRight=new d(this,R,90,w.clone(-45),i),this.center.setOnMoveLayout(this.onMoveCenter.bind(this)),this.topLeft.setOnMoveLayout(this.onMoveTopLeft.bind(this)),this.topCenter.setOnMoveLayout(this.onMoveTopCenter.bind(this)),this.topRight.setOnMoveLayout(this.onMoveTopRight.bind(this)),this.centerLeft.setOnMoveLayout(this.onMoveCenterLeft.bind(this)),this.centerRight.setOnMoveLayout(this.onMoveCenterRight.bind(this)),this.bottomLeft.setOnMoveLayout(this.onMoveBottomLeft.bind(this)),this.bottomCenter.setOnMoveLayout(this.onMoveBottomCenter.bind(this)),this.bottomRight.setOnMoveLayout(this.onMoveBottomRight.bind(this)),this.center.setOnEndLayout(this.onEndLayout.bind(this)),this.topLeft.setOnEndLayout(this.onEndLayout.bind(this)),this.topCenter.setOnEndLayout(this.onEndLayout.bind(this)),this.topRight.setOnEndLayout(this.onEndLayout.bind(this)),this.centerLeft.setOnEndLayout(this.onEndLayout.bind(this)),this.centerRight.setOnEndLayout(this.onEndLayout.bind(this)),this.bottomLeft.setOnEndLayout(this.onEndLayout.bind(this)),this.bottomCenter.setOnEndLayout(this.onEndLayout.bind(this)),this.bottomRight.setOnEndLayout(this.onEndLayout.bind(this)),this.layoutList=[this.topLeft,this.topCenter,this.topRight,this.centerLeft,this.centerRight,this.bottomLeft,this.bottomCenter,this.bottomRight,this.center]}onEndLayout(){this.onEndSelect?.call(this,this.rect)}setOnMoveLayout(t){this.onMoveLayout=t}setOnEndSelect(t){this.onEndSelect=t}onMoveCenter(t){const e=this.rect.clone();e.left+=t.x,e.top+=t.y,e.right+=t.x,e.bottom+=t.y,this.rect=e,this.setRect(this.rect)}onMoveTopLeft(t){const e=this.rect.clone();if(e.left+=t.x,e.top+=t.y,e.left>=e.right-12&&(e.left=e.right-12),e.top>=e.bottom-12&&(e.top=e.bottom-12),this.config?.outWidth&&this.config?.outHeight){const i=this.config?.outWidth>this.config?.outHeight?e.width/this.config?.outWidth:e.height/this.config?.outHeight,s=this.config?.outWidth*i,o=this.config?.outHeight*i;e.left+=e.width-s,e.top+=e.height-o}this.rect=e,this.setRect(this.rect)}onMoveTopCenter(t){const e=this.rect.clone();if(e.top+=t.y,e.top>=e.bottom-12&&(e.top=e.bottom-12),this.config?.outWidth&&this.config?.outHeight){const i=e.height/this.config?.outHeight,s=this.config?.outWidth*i;e.left+=(e.width-s)/2,e.right=e.left+s,e.bottom=e.top+this.config?.outHeight*i}this.rect=e,this.setRect(this.rect)}onMoveTopRight(t){const e=this.rect.clone();if(e.right+=t.x,e.top+=t.y,e.right<=e.left+12&&(e.right=e.left+12),e.top>=e.bottom-12&&(e.top=e.bottom-12),this.config?.outWidth&&this.config?.outHeight){const i=this.config?.outWidth>this.config?.outHeight?e.width/this.config?.outWidth:e.height/this.config?.outHeight;e.right=e.left+this.config?.outWidth*i,e.top+=e.height-this.config?.outHeight*i}this.rect=e,this.setRect(this.rect)}onMoveCenterLeft(t){const e=this.rect.clone();if(e.left+=t.x,e.left>=e.right-12&&(e.left=e.right-12),this.config?.outWidth&&this.config?.outHeight){const i=e.width/this.config?.outWidth,s=this.config?.outHeight*i;e.top+=(e.height-s)/2,e.bottom=e.top+s,e.right=e.left+this.config?.outWidth*i}this.rect=e,this.setRect(this.rect)}onMoveCenterRight(t){const e=this.rect.clone();if(e.right+=t.x,e.right<=e.left+12&&(e.right=e.left+12),this.config?.outWidth&&this.config?.outHeight){const i=e.width/this.config?.outWidth,s=this.config?.outHeight*i;e.top+=(e.height-s)/2,e.bottom=e.top+s,e.right=e.left+this.config?.outWidth*i}this.rect=e,this.setRect(this.rect)}onMoveBottomLeft(t){const e=this.rect.clone();if(e.left+=t.x,e.bottom+=t.y,e.left>=e.right-12&&(e.left=e.right-12),e.bottom<=e.top+12&&(e.bottom=e.top+12),this.config?.outWidth&&this.config?.outHeight){const i=this.config?.outWidth>this.config?.outHeight?e.width/this.config?.outWidth:e.height/this.config?.outHeight;e.left+=e.width-this.config?.outWidth*i,e.bottom=e.top+this.config?.outHeight*i}this.rect=e,this.setRect(this.rect)}onMoveBottomCenter(t){const e=this.rect.clone();if(e.bottom+=t.y,e.bottom<=e.top+12&&(e.bottom=e.top+12),this.config?.outWidth&&this.config?.outHeight){const i=e.height/this.config?.outHeight,s=this.config?.outWidth*i;e.left+=(e.width-s)/2,e.right=e.left+s,e.bottom=e.top+this.config?.outHeight*i}this.rect=e,this.setRect(this.rect)}onMoveBottomRight(t){const e=this.rect.clone();if(e.right+=t.x,e.bottom+=t.y,e.right<=e.left+12&&(e.right=e.left+12),e.bottom<=e.top+12&&(e.bottom=e.top+12),this.config?.outWidth&&this.config?.outHeight){const i=this.config?.outWidth>this.config?.outHeight?e.width/this.config?.outWidth:e.height/this.config?.outHeight;e.right=e.left+this.config?.outWidth*i,e.bottom=e.top+this.config?.outHeight*i}this.rect=e,this.setRect(this.rect)}start(t){return super.start(t)?!0:this.checkPointInRect(t)?(this.isChecked=!0,this.mousePoint=t,!0):!1}move(t){return this.isChecked&&(this.onMoveLayout?.call(this,new n(t.x-this.mousePoint.x,t.y-this.mousePoint.y)),this.mousePoint=t),super.move(t)}end(t){return this.isChecked&&(this.onMoveLayout?.call(this,new n(t.x-this.mousePoint.x,t.y-this.mousePoint.y)),this.mousePoint=t,this.isChecked=!1),super.end(t)}setRect(t){super.setRect(t);const{left:e,top:i,right:s,bottom:o}=t,c=s-e,r=o-i,h=this.config.pointRadius*2;this.center.setRect(a.fromSize(e+c/2,i+r/2,h,h)),this.topLeft.setRect(a.fromSize(e,i,h,h)),this.topCenter.setRect(a.fromSize(e+c/2,i,h,h)),this.topRight.setRect(a.fromSize(s,i,h,h)),this.centerLeft.setRect(a.fromSize(e,i+r/2,h,h)),this.centerRight.setRect(a.fromSize(s,i+r/2,h,h)),this.bottomLeft.setRect(a.fromSize(e,o,h,h)),this.bottomCenter.setRect(a.fromSize(e+c/2,o,h,h)),this.bottomRight.setRect(a.fromSize(s,o,h,h))}drawEllipse(t,e,i,s,o){const c=.5522848,r=s/2*c,h=o/2*c,g=e+s,u=i+o,p=e+s/2,m=i+o/2;t.moveTo(e,m),t.bezierCurveTo(e,m-h,p-r,i,p,i),t.bezierCurveTo(p+r,i,g,m-h,g,m),t.bezierCurveTo(g,m+h,p+r,u,p,u),t.bezierCurveTo(p-r,u,e,m+h,e,m)}drawMask(t){this.config.circle?this.drawEllipse(t,this.rect.left,this.rect.top,this.rect.width,this.rect.height):t.roundRect(this.rect.left,this.rect.top,this.rect.width,this.rect.height,this.config.circleRadius??0)}drawLine(t,e,i){t.save(),t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(i.x,i.y),t.closePath(),t.setLineDash([this.config.guidelineDsah,this.config.guidelineDsah]),t.lineWidth=this.config.guidelineWidth,t.strokeStyle=this.config.guidelineColor1,t.lineDashOffset=0,t.stroke(),t.strokeStyle=this.config.guidelineColor2,t.lineDashOffset=this.config.guidelineDsah,t.stroke(),t.restore()}draw(t){const{left:e,top:i,right:s,bottom:o}=this.rect;let c=s-e,r=o-i;t.lineWidth=this.config.borderWidth,t.beginPath(),t.rect(e-1,i-1,c+2,r+2),t.closePath(),t.strokeStyle=this.config.borderColor2,t.stroke(),t.beginPath(),this.config.circle?this.drawEllipse(t,e,i,c,r):t.roundRect(e,i,c,r,this.config.circleRadius??0),t.closePath(),t.strokeStyle=this.config.borderColor1,t.stroke(),c=c/3,r=r/3,this.drawLine(t,new n(e,i+r),new n(s,i+r)),this.drawLine(t,new n(e,i+r*2),new n(s,i+r*2)),this.drawLine(t,new n(e+c,i),new n(e+c,o)),this.drawLine(t,new n(e+c*2,i),new n(e+c*2,o)),super.draw(t)}}class d extends L{constructor(t,e,i,s,o){super(t,s,o),this.isChecked=!1,this.mousePoint=new n(0,0),this.onMoveLayout=null,this.onEndLayout=null,this.icon=e.clone(),this.icon.setAngle(i)}setOnMoveLayout(t){this.onMoveLayout=t}setOnEndLayout(t){this.onEndLayout=t}setRect(t){super.setRect(new a(t.left-this.config.pointRadius,t.top-this.config.pointRadius,t.right-this.config.pointRadius,t.bottom-this.config.pointRadius))}start(t){return this.checkPointInRect(t)?(this.isChecked=!0,this.mousePoint=t,!0):!1}move(t){return this.isChecked&&(this.onMoveLayout?.call(this,new n(t.x-this.mousePoint.x,t.y-this.mousePoint.y)),this.mousePoint=t),!1}end(t){return this.isChecked&&(this.onEndLayout?.call(this,new n(t.x-this.mousePoint.x,t.y-this.mousePoint.y)),this.mousePoint=t,this.isChecked=!1),!1}draw(t){t.save(),t.translate(this.rect.left,this.rect.top),this.icon.draw(t,this.rect.width,this.rect.height,this.config.borderColor1,this.config.borderColor2,this.config.borderWidth),t.restore()}}class B extends d{draw(t){t.save(),t.translate(this.rect.left,this.rect.top),this.icon.draw(t,this.rect.width,this.rect.height,this.config.borderColor2,this.config.borderColor1,this.config.borderWidth),t.restore()}}class D extends L{constructor(t,e,i){super(t,e,i),this.maskColor="#88888888",this.isSelect=!0,this.isChecked=!1,this.mousePoint=new n(0,0),this.onRotateLayout=null,this.handle=new W(this,k,i),this.layoutList.push(this.handle)}setOnRotateLayout(t){this.onRotateLayout=t}setOnEndSelect(t){this.handle.setOnEndSelect(t)}start(t){return this.isSelect?!1:(super.start(t)||this.checkPointInRect(t)&&(this.isChecked=!0,this.mousePoint=t),!0)}move(t){if(this.isSelect)return!1;const e=this.handle.getRect(),i=new n(e.left+e.width/2,e.top+e.height/2);let s=t.x-i.x,o=t.y-i.y,c=0-i.x,r=0-i.y,h=(Math.atan2(o,s)-Math.atan2(r,c))*(180/Math.PI);return this.cursor?.setAngle(-100+h),this.isChecked?(s=t.x-i.x,o=t.y-i.y,c=this.mousePoint.x-i.x,r=this.mousePoint.y-i.y,h=(Math.atan2(r,c)-Math.atan2(o,s))*(180/Math.PI),this.onRotateLayout?.call(this,h),this.mousePoint=t,!0):(super.move(t),!0)}end(t){return this.isSelect?!1:(this.isChecked=!1,super.end(t),!0)}setHandleRect(t){this.handle.setRect(t)}endSelect(t){this.handle.setRect(t),this.isSelect=!1}setOnMoveLayout(t){this.handle.setOnMoveLayout(t)}draw(t){const{left:e,top:i,right:s,bottom:o}=this.rect,c=s-e,r=o-i;t.save(),t.beginPath(),t.rect(e,i,c,r),this.handle.drawMask(t),t.closePath(),t.fillStyle=this.maskColor,t.fill("evenodd"),t.restore(),super.draw(t)}getClipRect(){return this.handle.getRect()}}class I extends L{constructor(t,e){super(null,null,e),this.overLayout=null,this.layoutList=[],this.mouseOver=!1,this.background=new H(this,e);const{width:i,height:s}=t.getBoundingClientRect();t.style.cursor="none",t.width=i,t.height=s,this.canvas=t,this.canvas2D=t.getContext("2d"),this.setRect(new a(0,0,this.canvas.width,this.canvas.height)),this.initBackground(),this.initClipRect(e?.defaultClipRect),t.addEventListener("mousedown",this.onMouseDown.bind(this)),t.addEventListener("mousemove",this.onMouseMove.bind(this)),t.addEventListener("mouseup",this.onMouseUp.bind(this)),t.addEventListener("wheel",this.onMouseWheel.bind(this)),t.addEventListener("mouseover",this.onMouseOver.bind(this)),t.addEventListener("mouseout",this.onMouseOut.bind(this)),t.addEventListener("touchstart",this.onTouchStart.bind(this)),t.addEventListener("touchmove",this.onTouchMove.bind(this)),t.addEventListener("touchend",this.onTouchEnd.bind(this)),this.draw(this.canvas2D)}setCursor(t){this.drawCursor=t}start(t){return super.start(this.mousePoint=t),this.draw(this.canvas2D),!0}move(t){return this.checkOverOut(t),super.move(this.mousePoint=t),this.draw(this.canvas2D),!0}end(t){return super.end(this.mousePoint=t),this.draw(this.canvas2D),!0}onTouchStart(t){t.preventDefault(),t.touches.length!==0&&this.start(new n(t.touches[0].clientX,t.touches[0].clientY))}onTouchMove(t){t.preventDefault(),t.touches.length!==0&&this.move(new n(t.touches[0].clientX,t.touches[0].clientY))}onTouchEnd(t){t.preventDefault(),this.end(new n(t.changedTouches[0].clientX,t.changedTouches[0].clientY))}onMouseDown(t){t.preventDefault(),this.start(this.mousePoint=new n(t.offsetX,t.offsetY))}onMouseMove(t){t.preventDefault(),this.move(new n(t.offsetX,t.offsetY))}onMouseUp(t){t.preventDefault(),this.end(new n(t.offsetX,t.offsetY))}onMouseOver(t){this.move(new n(t.offsetX,t.offsetY)),this.mouseOver=!0,this.draw(this.canvas2D)}onMouseOut(t){this.mouseOver=!1,this.draw(this.canvas2D)}onMouseWheel(t){t.preventDefault(),this.wheel(new O(t.deltaX,t.deltaY,t.deltaZ)),this.draw(this.canvas2D)}setImage(t){if(this.image=new E(this,this.config),this.image.setRect(this.rect.clone()),this.image.setImage(t),this.mask){const e=this.mask.getClipRect().clone();this.image?.setClipRect(e),this.image.initScale(e)}this.layoutList.splice(1,0,this.image),this.draw(this.canvas2D)}setOverLayout(t){this.overLayout!=t&&(this.overLayout?.out(),this.overLayout=t,this.overLayout.over())}toDataUrl(t,e){return this.image?this.mask?this.image.toDataUrl(t,e):Promise.reject("No mask"):Promise.reject("No image")}toBlob(t,e){return this.image?this.mask?this.image.toBlob(t,e):Promise.reject("No mask"):Promise.reject("No image")}initBackground(){this.background.setRect(this.rect),this.layoutList.push(this.background),this.background.setOnStartSelect(t=>{this.mask||this.createMask(t.clone())}),this.background.setOnMoveSelect(t=>{this.mask?.setHandleRect(t.clone())}),this.background.setOnEndSelect(t=>{this.mask?.endSelect(t.clone()),this.image?.setClipRect(t.clone())})}reset(){this.mask?.remove(),this.mask=void 0,this.initClipRect(this.config?.defaultClipRect),this.image?.reset(),this.draw(this.canvas2D)}initClipRect(t){if(t){const e=new a(t.left,t.top,this.rect.right-t.right,this.rect.bottom-t.bottom);if(this.config?.outWidth&&this.config?.outHeight){const i=Math.min(e.width/this.config?.outWidth,e.height/this.config?.outHeight),s=this.config?.outWidth*i,o=this.config?.outHeight*i;e.left=(this.rect.width-s)/2,e.top=(this.rect.height-o)/2,e.right=e.left+s,e.bottom=e.top+o}else if(this.config?.outWidth){const i=e.width/this.config?.outWidth,s=this.config?.outWidth*i;e.left=(this.rect.width-s)/2,e.right=e.left+s}else if(this.config?.outHeight){const i=e.height/this.config?.outHeight,s=this.config?.outHeight*i;e.top=(this.rect.height-s)/2,e.bottom=e.top+s}this.image?.setClipRect(e.clone()),this.createMask(e),this.mask?.endSelect(e)}}createMask(t){this.mask=new D(this,C,this.config),this.mask.setOnMoveLayout(e=>{this.image?.moveImage(e)}),this.mask.setOnRotateLayout(e=>{this.image?.setRotate(e)}),this.mask.setOnEndSelect(e=>{this.image?.setClipRect(e.clone())}),this.mask.setRect(this.rect),this.mask.setHandleRect(t),this.layoutList.push(this.mask)}draw(t){super.draw(t),this.mousePoint&&this.drawCursor&&this.mouseOver&&(t.save(),t.translate(this.mousePoint.x-this.config.cursorSize/2,this.mousePoint.y-this.config.cursorSize/2),this.drawCursor.draw(t,this.config.cursorSize,this.config.cursorSize,this.config.cursorStrokeColor,this.config.cursorColor,this.config.cursorStrokeLineWidth),t.restore())}}return I}));
